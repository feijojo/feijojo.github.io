<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HTML代码编辑器 | 上传、编辑、预览与保存</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <script>
    // Tailwind 配置
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#165DFF',
            secondary: '#6B7280',
            dark: '#1E293B',
            light: '#F8FAFC',
            success: '#10B981',
            warning: '#F59E0B',
            danger: '#EF4444',
          },
          fontFamily: {
            mono: ['Consolas', 'Monaco', 'Courier New', 'monospace'],
            sans: ['Inter', 'system-ui', 'sans-serif'],
          },
          boxShadow: {
            'card': '0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05)',
            'hover': '0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04)',
          }
        },
      }
    }
  </script>
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .editor-shadow {
        box-shadow: 0 0 0 1px rgba(0, 0, 0, 0.1), 0 2px 4px rgba(0, 0, 0, 0.08);
      }
      .transition-all-300 {
        transition: all 300ms ease-in-out;
      }
      .scrollbar-thin {
        scrollbar-width: thin;
      }
      .scrollbar-thin::-webkit-scrollbar {
        width: 6px;
        height: 6px;
      }
      .scrollbar-thin::-webkit-scrollbar-thumb {
        background-color: rgba(156, 163, 175, 0.5);
        border-radius: 3px;
      }
      .scrollbar-thin::-webkit-scrollbar-track {
        background: transparent;
      }
      .text-shadow-sm {
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
      }
      .preview-iframe {
        border: none;
        width: 100%;
        height: 100%;
        min-height: 600px;
      }
      /* 增强hidden类优先级，确保隐藏生效 */
      .hidden {
        display: none !important;
      }
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen font-sans text-dark">
  <!-- 顶部导航栏 -->
  <header class="bg-white shadow-md fixed top-0 left-0 right-0 z-50 transition-all duration-300">
    <div class="container mx-auto px-4 py-3 flex flex-wrap items-center justify-between">
      <div class="flex items-center space-x-2">
        <i class="fa fa-code text-primary text-2xl"></i>
        <h1 class="text-xl md:text-2xl font-bold text-gray-800">HTML代码编辑器</h1>
      </div>
      
      <div class="flex items-center space-x-3 mt-2 md:mt-0">
        <button id="theme-toggle" class="p-2 rounded-full hover:bg-gray-100 transition-all-300">
          <i class="fa fa-moon-o text-gray-600"></i>
        </button>
        <button id="preview-btn" class="p-2 rounded-full hover:bg-gray-100 transition-all-300">
          <i class="fa fa-eye text-primary"></i>
        </button>
        <button id="help-btn" class="p-2 rounded-full hover:bg-gray-100 transition-all-300">
          <i class="fa fa-question-circle text-gray-600"></i>
        </button>
      </div>
    </div>
  </header>

  <!-- 主内容区 -->
  <main class="container mx-auto px-4 pt-24 pb-16">
    <!-- 上传区域 -->
    <section id="upload-section" class="bg-white rounded-xl p-6 mb-6 shadow-card transition-all-300 hover:shadow-hover">
      <div class="flex flex-col md:flex-row items-center justify-between">
        <div class="mb-4 md:mb-0">
          <h2 class="text-xl font-semibold text-gray-800 mb-2">上传HTML文件</h2>
          <p class="text-gray-600">选择本地HTML文件进行编辑，或直接在编辑器中输入代码</p>
          <p class="text-xs text-gray-500 mt-1">提示：建议使用VS Code Live Server等工具在HTTP环境下运行，避免本地文件权限问题</p>
        </div>
        
        <div class="flex items-center space-x-3">
          <label for="file-upload" class="flex items-center space-x-2 bg-primary hover:bg-primary/90 text-white px-5 py-2.5 rounded-lg cursor-pointer transition-all-300 shadow-md hover:shadow-lg">
            <i class="fa fa-upload"></i>
            <span>选择文件</span>
          </label>
          <input id="file-upload" type="file" accept=".html" class="hidden">
          
          <button id="create-new" class="flex items-center space-x-2 bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 px-5 py-2.5 rounded-lg transition-all-300 shadow-sm hover:shadow">
            <i class="fa fa-file-code-o"></i>
            <span>新建文件</span>
          </button>
        </div>
      </div>
      
      <div id="file-info" class="mt-4 p-3 bg-gray-50 rounded-lg hidden">
        <div class="flex items-center justify-between">
          <div class="flex items-center space-x-2">
            <i class="fa fa-file-html-o text-primary"></i>
            <span id="file-name" class="font-medium text-gray-800"></span>
          </div>
          <button id="remove-file" class="text-gray-500 hover:text-danger transition-all-300">
            <i class="fa fa-times"></i>
          </button>
        </div>
        <!-- 上传进度条 -->
        <div id="upload-progress" class="mt-3 hidden">
          <div class="w-full bg-gray-200 rounded-full h-2.5">
            <div id="progress-bar" class="bg-primary h-2.5 rounded-full" style="width: 0%"></div>
          </div>
          <p id="progress-text" class="text-xs text-gray-500 mt-1">读取中... 0%</p>
        </div>
      </div>
    </section>

    <!-- 编辑器区域 -->
    <section class="grid grid-cols-1 lg:grid-cols-4 gap-6">
      <!-- 左侧工具栏 -->
      <div class="lg:col-span-1 space-y-6">
        <!-- 查找替换工具 -->
        <div class="bg-white rounded-xl p-5 shadow-card transition-all-300 hover:shadow-hover">
          <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
            <i class="fa fa-search text-primary mr-2"></i>查找与替换
          </h3>
          
          <div class="space-y-4">
            <div>
              <label for="find-input" class="block text-sm font-medium text-gray-700 mb-1">查找</label>
              <div class="relative">
                <input type="text" id="find-input" placeholder="输入要查找的内容" 
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all-300">
                <button id="find-btn" class="absolute right-3 top-1/2 -translate-y-1/2 text-primary hover:text-primary/80 transition-all-300">
                  <i class="fa fa-search"></i>
                </button>
              </div>
              <p id="find-count" class="text-xs text-gray-500 mt-1 hidden">找到 <span id="match-count">0</span> 个匹配项</p>
            </div>
            
            <div>
              <label for="replace-input" class="block text-sm font-medium text-gray-700 mb-1">替换为</label>
              <input type="text" id="replace-input" placeholder="输入替换内容" 
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all-300">
            </div>
            
            <div class="flex space-x-3">
              <button id="replace-btn" class="flex-1 bg-primary/10 hover:bg-primary/20 text-primary px-4 py-2 rounded-lg transition-all-300 flex items-center justify-center">
                <i class="fa fa-exchange mr-1"></i> 替换
              </button>
              <button id="replace-all-btn" class="flex-1 bg-primary hover:bg-primary/90 text-white px-4 py-2 rounded-lg transition-all-300 flex items-center justify-center">
                <i class="fa fa-refresh mr-1"></i> 全部替换
              </button>
            </div>
          </div>
        </div>
        
        <!-- 代码整理工具 -->
        <div class="bg-white rounded-xl p-5 shadow-card transition-all-300 hover:shadow-hover">
          <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
            <i class="fa fa-code-fork text-primary mr-2"></i>代码整理
          </h3>
          
          <div class="space-y-3">
            <button id="consolidate-css-btn" class="w-full flex items-center justify-center space-x-2 bg-primary/10 hover:bg-primary/20 text-primary px-4 py-2.5 rounded-lg transition-all-300">
              <i class="fa fa-css3"></i>
              <span>整合CSS代码</span>
            </button>
            
            <button id="consolidate-js-btn" class="w-full flex items-center justify-center space-x-2 bg-primary/10 hover:bg-primary/20 text-primary px-4 py-2.5 rounded-lg transition-all-300">
              <i class="fa fa-js"></i>
              <span>整合JS代码</span>
            </button>
            
            <button id="consolidate-all-btn" class="w-full flex items-center justify-center space-x-2 bg-primary hover:bg-primary/90 text-white px-4 py-2.5 rounded-lg transition-all-300 mt-2">
              <i class="fa fa-magic"></i>
              <span>整合所有代码</span>
            </button>
          </div>
        </div>
        
        <!-- 操作工具 -->
        <div class="bg-white rounded-xl p-5 shadow-card transition-all-300 hover:shadow-hover">
          <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
            <i class="fa fa-cog text-primary mr-2"></i>编辑工具
          </h3>
          
          <div class="space-y-3">
            <button id="preview-tool-btn" class="w-full flex items-center justify-center space-x-2 bg-primary/10 hover:bg-primary/20 text-primary px-4 py-2.5 rounded-lg transition-all-300">
              <i class="fa fa-eye"></i>
              <span>预览网页</span>
            </button>
            
            <button id="format-btn" class="w-full flex items-center justify-center space-x-2 bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2.5 rounded-lg transition-all-300">
              <i class="fa fa-indent"></i>
              <span>格式化代码</span>
            </button>
            
            <button id="clear-btn" class="w-full flex items-center justify-center space-x-2 bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2.5 rounded-lg transition-all-300">
              <i class="fa fa-trash-o"></i>
              <span>清空编辑器</span>
            </button>
            
            <button id="save-btn" class="w-full flex items-center justify-center space-x-2 bg-success hover:bg-success/90 text-white px-4 py-2.5 rounded-lg transition-all-300 mt-4 shadow-md hover:shadow-lg">
              <i class="fa fa-download"></i>
              <span>保存HTML文件</span>
            </button>
          </div>
        </div>
      </div>
      
      <!-- 右侧编辑器 -->
      <div class="lg:col-span-3">
        <div class="bg-white rounded-xl shadow-card transition-all-300 hover:shadow-hover overflow-hidden">
          <div class="p-4 border-b border-gray-200 flex items-center justify-between">
            <h3 class="text-lg font-semibold text-gray-800 flex items-center">
              <i class="fa fa-code text-primary mr-2"></i>代码编辑区
            </h3>
            <div class="flex items-center space-x-2">
              <span id="line-count" class="text-sm text-gray-500">0 行</span>
              <span id="char-count" class="text-sm text-gray-500">0 字符</span>
            </div>
          </div>
          
          <div class="relative">
            <!-- 行号 -->
            <div id="line-numbers" class="absolute left-0 top-0 bottom-0 w-12 bg-gray-100 text-gray-500 text-right p-4 font-mono text-sm overflow-hidden select-none">
              <!-- 行号将通过JS动态生成 -->
            </div>
            
            <!-- 编辑器文本区域 -->
            <textarea id="code-editor" class="w-full h-[600px] font-mono text-sm p-4 pl-16 border-0 outline-none resize-none scrollbar-thin bg-white" 
              placeholder="在此输入或粘贴HTML代码，或上传HTML文件进行编辑..."></textarea>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- 帮助模态框 -->
  <div id="help-modal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center hidden">
    <div class="bg-white rounded-xl max-w-2xl w-full max-h-[80vh] overflow-y-auto m-4 shadow-xl">
      <div class="p-6 border-b border-gray-200 flex items-center justify-between">
        <h3 class="text-xl font-bold text-gray-800">使用帮助</h3>
        <button id="close-help" class="text-gray-500 hover:text-gray-700 transition-all-300">
          <i class="fa fa-times text-xl"></i>
        </button>
      </div>
      
      <div class="p-6 space-y-4">
        <div>
          <h4 class="font-semibold text-lg text-gray-800 mb-2">1. 上传HTML文件</h4>
          <p class="text-gray-600">点击"选择文件"按钮，选择本地的HTML文件，文件内容将自动加载到编辑器中。</p>
          <p class="text-gray-500 text-sm mt-1">重要：如果上传失败，请使用VS Code Live Server等工具在HTTP服务器环境下运行本页面，避免本地文件权限限制。</p>
        </div>
        
        <div>
          <h4 class="font-semibold text-lg text-gray-800 mb-2">2. 编辑代码</h4>
          <p class="text-gray-600">在代码编辑区可以直接输入、修改HTML代码，编辑器会实时显示行号和字符数。</p>
        </div>
        
        <div>
          <h4 class="font-semibold text-lg text-gray-800 mb-2">3. 代码整理</h4>
          <ul class="text-gray-600 list-disc pl-5 space-y-1">
            <li>点击"整合CSS代码"按钮，可将所有CSS代码合并到一个&lt;style&gt;标签中</li>
            <li>点击"整合JS代码"按钮，可将所有JavaScript代码合并到一个&lt;script&gt;标签中</li>
            <li>点击"整合所有代码"按钮，可同时完成CSS和JS代码的整合</li>
          </ul>
        </div>
        
        <div>
          <h4 class="font-semibold text-lg text-gray-800 mb-2">4. 查找与替换</h4>
          <ul class="text-gray-600 list-disc pl-5 space-y-1">
            <li>在"查找"输入框中输入要查找的内容，点击查找按钮或按Enter键</li>
            <li>在"替换为"输入框中输入替换内容</li>
            <li>点击"替换"按钮替换当前匹配项，点击"全部替换"替换所有匹配项</li>
          </ul>
        </div>
        
        <div>
          <h4 class="font-semibold text-lg text-gray-800 mb-2">5. 预览网页</h4>
          <p class="text-gray-600">点击顶部导航栏的"预览"图标或左侧工具栏的"预览网页"按钮，可以查看编辑后的HTML效果。预览窗口支持刷新和全屏查看。</p>
        </div>
        
        <div>
          <h4 class="font-semibold text-lg text-gray-800 mb-2">6. 格式化代码</h4>
          <p class="text-gray-600">点击"格式化代码"按钮可以自动整理HTML代码格式，使其更易读。</p>
        </div>
        
        <div>
          <h4 class="font-semibold text-lg text-gray-800 mb-2">7. 保存文件</h4>
          <p class="text-gray-600">编辑完成后，点击"保存HTML文件"按钮，将编辑后的代码保存为新的HTML文件。</p>
        </div>
      </div>
    </div>
  </div>

  <!-- 预览模态框 -->
  <div id="preview-modal" class="fixed inset-0 bg-black/70 z-50 flex items-center justify-center hidden">
    <div class="bg-white rounded-xl max-w-6xl w-full max-h-[90vh] overflow-hidden m-4 shadow-2xl flex flex-col">
      <div class="p-4 border-b border-gray-200 flex items-center justify-between bg-gray-50">
        <h3 class="text-xl font-bold text-gray-800 flex items-center">
          <i class="fa fa-eye text-primary mr-2"></i>网页预览
        </h3>
        <div class="flex items-center space-x-3">
          <button id="refresh-preview" class="p-2 rounded-full hover:bg-gray-200 transition-all-300" title="刷新预览">
            <i class="fa fa-refresh text-gray-700"></i>
          </button>
          <button id="fullscreen-preview" class="p-2 rounded-full hover:bg-gray-200 transition-all-300" title="全屏预览">
            <i class="fa fa-expand text-gray-700"></i>
          </button>
          <button id="close-preview" class="p-2 rounded-full hover:bg-gray-200 transition-all-300" title="关闭预览">
            <i class="fa fa-times text-gray-700"></i>
          </button>
        </div>
      </div>
      
      <div class="flex-1 overflow-hidden relative">
        <!-- 预览加载中提示 -->
        <div id="preview-loading" class="absolute inset-0 flex items-center justify-center bg-white z-10">
          <div class="flex flex-col items-center">
            <div class="w-12 h-12 border-4 border-primary border-t-transparent rounded-full animate-spin mb-3"></div>
            <p class="text-gray-600">加载预览中...</p>
          </div>
        </div>
        
        <!-- 预览iframe -->
        <iframe id="preview-iframe" class="preview-iframe"></iframe>
        
        <!-- 预览错误提示 -->
        <div id="preview-error" class="absolute inset-0 flex items-center justify-center bg-white z-10 hidden">
          <div class="flex flex-col items-center text-center p-6">
            <i class="fa fa-exclamation-triangle text-warning text-4xl mb-3"></i>
            <h4 class="text-lg font-semibold text-gray-800 mb-2">预览失败</h4>
            <p class="text-gray-600 mb-4">HTML代码存在语法错误，请检查代码后重试</p>
            <button id="retry-preview" class="bg-primary hover:bg-primary/90 text-white px-4 py-2 rounded-lg transition-all-300">
              重试预览
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 通知提示 -->
  <div id="notification" class="fixed bottom-6 right-6 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all-300 flex items-center space-x-2 z-50 hidden">
    <i id="notification-icon" class="fa fa-check-circle text-success"></i>
    <span id="notification-message">操作成功！</span>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // DOM元素
      const fileUpload = document.getElementById('file-upload');
      const fileInfo = document.getElementById('file-info');
      const fileName = document.getElementById('file-name');
      const removeFile = document.getElementById('remove-file');
      const codeEditor = document.getElementById('code-editor');
      const lineNumbers = document.getElementById('line-numbers');
      const lineCount = document.getElementById('line-count');
      const charCount = document.getElementById('char-count');
      const findInput = document.getElementById('find-input');
      const replaceInput = document.getElementById('replace-input');
      const findBtn = document.getElementById('find-btn');
      const replaceBtn = document.getElementById('replace-btn');
      const replaceAllBtn = document.getElementById('replace-all-btn');
      const findCount = document.getElementById('find-count');
      const matchCount = document.getElementById('match-count');
      const formatBtn = document.getElementById('format-btn');
      const clearBtn = document.getElementById('clear-btn');
      const saveBtn = document.getElementById('save-btn');
      const helpBtn = document.getElementById('help-btn');
      const helpModal = document.getElementById('help-modal');
      const closeHelp = document.getElementById('close-help');
      const notification = document.getElementById('notification');
      const notificationMessage = document.getElementById('notification-message');
      const notificationIcon = document.getElementById('notification-icon');
      const themeToggle = document.getElementById('theme-toggle');
      const createNew = document.getElementById('create-new');
      
      // 新增元素
      const uploadProgress = document.getElementById('upload-progress');
      const progressBar = document.getElementById('progress-bar');
      const progressText = document.getElementById('progress-text');
      
      // 代码整理按钮
      const consolidateCssBtn = document.getElementById('consolidate-css-btn');
      const consolidateJsBtn = document.getElementById('consolidate-js-btn');
      const consolidateAllBtn = document.getElementById('consolidate-all-btn');
      
      // 预览相关元素
      const previewBtn = document.getElementById('preview-btn');
      const previewToolBtn = document.getElementById('preview-tool-btn');
      const previewModal = document.getElementById('preview-modal');
      const closePreview = document.getElementById('close-preview');
      const refreshPreview = document.getElementById('refresh-preview');
      const fullscreenPreview = document.getElementById('fullscreen-preview');
      const previewIframe = document.getElementById('preview-iframe');
      const previewLoading = document.getElementById('preview-loading');
      const previewError = document.getElementById('preview-error');
      const retryPreview = document.getElementById('retry-preview');
      
      // 变量
      let currentTheme = 'light';
      let currentMatches = [];
      let currentMatchIndex = -1;
      let originalFileName = 'untitled';
      let previewTimeout = null;
      const MAX_FILE_SIZE = 10 * 1024 * 1024; // 10MB
      
      // 初始化：确保所有隐藏元素正确隐藏
      function initHiddenElements() {
        helpModal.classList.add('hidden');
        previewModal.classList.add('hidden');
        notification.classList.add('hidden');
        fileInfo.classList.add('hidden');
        uploadProgress.classList.add('hidden');
        findCount.classList.add('hidden');
      }
      
      // 更新行号
      function updateLineNumbers() {
        const lines = codeEditor.value.split('\n');
        let lineNumbersHTML = '';
        
        for (let i = 1; i <= lines.length; i++) {
          lineNumbersHTML += `${i}\n`;
        }
        
        lineNumbers.textContent = lineNumbersHTML;
        lineCount.textContent = `${lines.length} 行`;
        charCount.textContent = `${codeEditor.value.length} 字符`;
      }
      
      // 上传文件处理 - 修复版
      fileUpload.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        // 检查文件类型
        if (file.type !== 'text/html' && !file.name.endsWith('.html')) {
          showNotification('请上传HTML格式的文件', 'error');
          return;
        }
        
        // 检查文件大小
        if (file.size > MAX_FILE_SIZE) {
          showNotification(`文件过大（${(file.size/1024/1024).toFixed(2)}MB），最大支持10MB`, 'error');
          return;
        }
        
        originalFileName = file.name.replace(/\.html$/, '');
        fileName.textContent = file.name;
        fileInfo.classList.remove('hidden');
        uploadProgress.classList.remove('hidden');
        progressBar.style.width = '0%';
        progressText.textContent = '读取中... 0%';
        
        const reader = new FileReader();
        
        // 进度更新（仅现代浏览器支持）
        if (reader.addEventListener) {
          reader.addEventListener('progress', function(e) {
            if (e.lengthComputable) {
              const progress = (e.loaded / e.total) * 100;
              progressBar.style.width = `${progress}%`;
              progressText.textContent = `读取中... ${Math.round(progress)}%`;
            }
          });
        }
        
        reader.onload = function(e) {
          try {
            // 确保内容是字符串
            const content = typeof e.target.result === 'string' ? e.target.result : '';
            codeEditor.value = content;
            updateLineNumbers();
            showNotification(`成功加载文件: ${file.name}`, 'success');
          } catch (error) {
            showNotification('文件内容解析失败', 'error');
            console.error('文件解析错误:', error);
          } finally {
            uploadProgress.classList.add('hidden');
          }
        };
        
        reader.onerror = function(error) {
          uploadProgress.classList.add('hidden');
          console.error('文件读取错误:', error);
          
          // 不同错误类型的提示
          let errorMsg = '文件读取失败，请重试';
          if (error.code === 1) errorMsg = '文件未找到';
          else if (error.code === 2) errorMsg = '文件读取被中止';
          else if (error.code === 3) errorMsg = '文件读取失败，请检查文件是否损坏';
          
          // 本地文件权限提示
          if (window.location.protocol === 'file:') {
            errorMsg += '（建议使用HTTP服务器环境运行，避免本地文件权限限制）';
          }
          
          showNotification(errorMsg, 'error');
        };
        
        reader.onabort = function() {
          uploadProgress.classList.add('hidden');
          showNotification('文件读取已中止', 'warning');
        };
        
        reader.readAsText(file);
      });
      
      // 移除文件
      removeFile.addEventListener('click', function() {
        fileUpload.value = '';
        fileInfo.classList.add('hidden');
        uploadProgress.classList.add('hidden');
        originalFileName = 'untitled';
        showNotification('已移除文件', 'info');
      });
      
      // 编辑器内容变化时更新行号和字符计数
      codeEditor.addEventListener('input', updateLineNumbers);
      
      // 同步滚动
      codeEditor.addEventListener('scroll', function() {
        lineNumbers.scrollTop = codeEditor.scrollTop;
        lineNumbers.scrollLeft = codeEditor.scrollLeft;
      });
      
      // 查找功能
      function findText() {
        const findText = findInput.value.trim();
        if (!findText) {
          currentMatches = [];
          currentMatchIndex = -1;
          findCount.classList.add('hidden');
          return;
        }
        
        const text = codeEditor.value;
        const regex = new RegExp(findText.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g');
        currentMatches = [];
        
        let match;
        while ((match = regex.exec(text)) !== null) {
          currentMatches.push({
            start: match.index,
            end: match.index + findText.length
          });
        }
        
        matchCount.textContent = currentMatches.length;
        findCount.classList.remove('hidden');
        
        // 高亮第一个匹配项
        if (currentMatches.length > 0) {
          currentMatchIndex = 0;
          highlightMatch(currentMatches[currentMatchIndex]);
        }
      }
      
      // 高亮匹配项
      function highlightMatch(match) {
        codeEditor.focus();
        codeEditor.setSelectionRange(match.start, match.end);
        codeEditor.scrollTop = codeEditor.scrollHeight * (match.start / codeEditor.value.length) - 100;
      }
      
      // 查找按钮点击
      findBtn.addEventListener('click', findText);
      
      // 查找框回车事件
      findInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
          findText();
          e.preventDefault();
        }
      });
      
      // 替换功能
      replaceBtn.addEventListener('click', function() {
        const findText = findInput.value.trim();
        const replaceText = replaceInput.value;
        
        if (!findText || currentMatches.length === 0) {
          showNotification('请先查找要替换的内容', 'warning');
          return;
        }
        
        // 如果没有选中任何匹配项，选中第一个
        if (currentMatchIndex === -1 && currentMatches.length > 0) {
          currentMatchIndex = 0;
        }
        
        if (currentMatchIndex >= 0 && currentMatchIndex < currentMatches.length) {
          const match = currentMatches[currentMatchIndex];
          const text = codeEditor.value;
          
          // 替换当前匹配项
          const newText = text.substring(0, match.start) + replaceText + text.substring(match.end);
          codeEditor.value = newText;
          
          // 更新匹配项位置
          const offset = replaceText.length - findText.length;
          currentMatches = currentMatches.map((m, index) => {
            if (index > currentMatchIndex) {
              return {
                start: m.start + offset,
                end: m.end + offset
              };
            }
            return m;
          });
          
          // 移动到下一个匹配项
          currentMatchIndex = (currentMatchIndex + 1) % currentMatches.length;
          
          if (currentMatches.length > 0) {
            highlightMatch(currentMatches[currentMatchIndex]);
          } else {
            currentMatchIndex = -1;
          }
          
          updateLineNumbers();
          showNotification('已替换当前匹配项', 'success');
        }
      });
      
      // 全部替换功能
      replaceAllBtn.addEventListener('click', function() {
        const findText = findInput.value.trim();
        const replaceText = replaceInput.value;
        
        if (!findText) {
          showNotification('请输入要查找的内容', 'warning');
          return;
        }
        
        const text = codeEditor.value;
        const regex = new RegExp(findText.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g');
        const newText = text.replace(regex, replaceText);
        
        const replacedCount = (text.match(regex) || []).length;
        codeEditor.value = newText;
        
        currentMatches = [];
        currentMatchIndex = -1;
        findCount.classList.add('hidden');
        
        updateLineNumbers();
        showNotification(`已替换 ${replacedCount} 个匹配项`, 'success');
      });
      
      // 格式化代码
      formatBtn.addEventListener('click', function() {
        try {
          const html = codeEditor.value;
          const formattedHtml = formatHTML(html);
          codeEditor.value = formattedHtml;
          updateLineNumbers();
          showNotification('代码格式化成功', 'success');
        } catch (error) {
          showNotification('代码格式化失败，请检查HTML语法', 'error');
          console.error('格式化错误:', error);
        }
      });
      
      // HTML格式化函数
      function formatHTML(html) {
        // 移除多余空格和换行
        let formatted = html.replace(/>\s+</g, '><');
        formatted = formatted.replace(/\n+/g, '\n');
        
        let indentLevel = 0;
        const indentSize = 2;
        const lines = formatted.split('\n');
        const result = [];
        
        const openingTags = /^<([a-z0-9]+)(\s|>)/i;
        const closingTags = /^<\/([a-z0-9]+)>/i;
        const selfClosingTags = /^<([a-z0-9]+)[^>]*\/>/i;
        
        for (let line of lines) {
          line = line.trim();
          if (!line) continue;
          
          // 处理闭合标签
          if (closingTags.test(line)) {
            indentLevel = Math.max(0, indentLevel - 1);
          }
          
          // 添加缩进
          const indent = ' '.repeat(indentLevel * indentSize);
          result.push(indent + line);
          
          // 处理开始标签
          if (openingTags.test(line) && !selfClosingTags.test(line) && !closingTags.test(line)) {
            indentLevel++;
          }
        }
        
        return result.join('\n');
      }
      
      // 清空编辑器
      clearBtn.addEventListener('click', function() {
        if (confirm('确定要清空编辑器内容吗？此操作不可撤销。')) {
          codeEditor.value = '';
          updateLineNumbers();
          showNotification('编辑器已清空', 'info');
        }
      });
      
      // 保存文件
      saveBtn.addEventListener('click', function() {
        const htmlContent = codeEditor.value.trim();
        if (!htmlContent) {
          showNotification('编辑器内容为空，无法保存', 'warning');
          return;
        }
        
        try {
          // 创建Blob对象
          const blob = new Blob([htmlContent], { type: 'text/html; charset=utf-8' });
          
          // 创建下载链接
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `${originalFileName}_edited.html`;
          document.body.appendChild(a);
          
          // 触发下载
          a.click();
          
          // 清理
          setTimeout(() => {
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
          }, 0);
          
          showNotification('文件保存成功', 'success');
        } catch (error) {
          showNotification('文件保存失败，请重试', 'error');
          console.error('保存错误:', error);
        }
      });
      
      // 帮助模态框
      helpBtn.addEventListener('click', function() {
        helpModal.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
      });
      
      closeHelp.addEventListener('click', function() {
        helpModal.classList.add('hidden');
        document.body.style.overflow = '';
      });
      
      helpModal.addEventListener('click', function(e) {
        if (e.target === helpModal) {
          helpModal.classList.add('hidden');
          document.body.style.overflow = '';
        }
      });
      
      // 通知提示
      function showNotification(message, type = 'success') {
        notificationMessage.textContent = message;
        
        // 设置图标
        notificationIcon.className = '';
        switch(type) {
          case 'success':
            notificationIcon.className = 'fa fa-check-circle text-success';
            break;
          case 'error':
            notificationIcon.className = 'fa fa-exclamation-circle text-danger';
            break;
          case 'warning':
            notificationIcon.className = 'fa fa-exclamation-triangle text-warning';
            break;
          case 'info':
            notificationIcon.className = 'fa fa-info-circle text-primary';
            break;
        }
        
        // 显示通知
        notification.classList.remove('translate-y-20', 'opacity-0', 'hidden');
        notification.classList.add('translate-y-0', 'opacity-100');
        
        // 3秒后隐藏
        setTimeout(() => {
          notification.classList.remove('translate-y-0', 'opacity-100');
          notification.classList.add('translate-y-20', 'opacity-0');
          setTimeout(() => {
            notification.classList.add('hidden');
          }, 300);
        }, 3000);
      }
      
      // 主题切换
      themeToggle.addEventListener('click', function() {
        if (currentTheme === 'light') {
          currentTheme = 'dark';
          document.body.classList.add('bg-gray-900', 'text-white');
          document.body.classList.remove('bg-gray-50', 'text-dark');
          codeEditor.classList.add('bg-gray-800', 'text-gray-100');
          codeEditor.classList.remove('bg-white', 'text-dark');
          lineNumbers.classList.add('bg-gray-700', 'text-gray-300');
          lineNumbers.classList.remove('bg-gray-100', 'text-gray-500');
          themeToggle.innerHTML = '<i class="fa fa-sun-o text-yellow-400"></i>';
          
          // 更新所有卡片背景
          document.querySelectorAll('.bg-white').forEach(el => {
            el.classList.remove('bg-white');
            el.classList.add('bg-gray-800', 'border-gray-700');
          });
          
          // 更新输入框样式
          document.querySelectorAll('input, textarea, select').forEach(el => {
            el.classList.add('bg-gray-700', 'border-gray-600', 'text-white');
            el.classList.remove('bg-white', 'border-gray-300', 'text-dark');
          });
          
          showNotification('已切换至深色模式', 'info');
        } else {
          currentTheme = 'light';
          document.body.classList.remove('bg-gray-900', 'text-white');
          document.body.classList.add('bg-gray-50', 'text-dark');
          codeEditor.classList.remove('bg-gray-800', 'text-gray-100');
          codeEditor.classList.add('bg-white', 'text-dark');
          lineNumbers.classList.remove('bg-gray-700', 'text-gray-300');
          lineNumbers.classList.add('bg-gray-100', 'text-gray-500');
          themeToggle.innerHTML = '<i class="fa fa-moon-o text-gray-600"></i>';
          
          // 更新所有卡片背景
          document.querySelectorAll('.bg-gray-800').forEach(el => {
            el.classList.remove('bg-gray-800', 'border-gray-700');
            el.classList.add('bg-white');
          });
          
          // 更新输入框样式
          document.querySelectorAll('input, textarea, select').forEach(el => {
            el.classList.remove('bg-gray-700', 'border-gray-600', 'text-white');
            el.classList.add('bg-white', 'border-gray-300', 'text-dark');
          });
          
          showNotification('已切换至浅色模式', 'info');
        }
      });
      
      // 新建文件
      createNew.addEventListener('click', function() {
        if (codeEditor.value.trim() !== '' && confirm('当前编辑器中有内容，新建文件将清空现有内容，是否继续？')) {
          codeEditor.value = '';
          fileUpload.value = '';
          fileInfo.classList.add('hidden');
          uploadProgress.classList.add('hidden');
          originalFileName = 'untitled';
          updateLineNumbers();
          showNotification('已创建新文件', 'info');
        } else if (codeEditor.value.trim() === '') {
          fileUpload.value = '';
          fileInfo.classList.add('hidden');
          uploadProgress.classList.add('hidden');
          originalFileName = 'untitled';
          showNotification('已创建新文件', 'info');
        }
      });
      
      // 代码整合功能
      consolidateCssBtn.addEventListener('click', function() {
        try {
          const html = codeEditor.value;
          const consolidatedHtml = consolidateCSS(html);
          codeEditor.value = consolidatedHtml;
          updateLineNumbers();
          showNotification('CSS代码整合成功', 'success');
        } catch (error) {
          showNotification('CSS代码整合失败，请检查HTML语法', 'error');
          console.error('CSS整合错误:', error);
        }
      });
      
      consolidateJsBtn.addEventListener('click', function() {
        try {
          const html = codeEditor.value;
          const consolidatedHtml = consolidateJS(html);
          codeEditor.value = consolidatedHtml;
          updateLineNumbers();
          showNotification('JavaScript代码整合成功', 'success');
        } catch (error) {
          showNotification('JavaScript代码整合失败，请检查HTML语法', 'error');
          console.error('JS整合错误:', error);
        }
      });
      
      consolidateAllBtn.addEventListener('click', function() {
        try {
          let html = codeEditor.value;
          html = consolidateCSS(html);
          html = consolidateJS(html);
          codeEditor.value = html;
          updateLineNumbers();
          showNotification('所有代码整合成功', 'success');
        } catch (error) {
          showNotification('代码整合失败，请检查HTML语法', 'error');
          console.error('代码整合错误:', error);
        }
      });
      
      // 整合CSS代码的函数
      function consolidateCSS(html) {
        const tempDiv = document.createElement('div');
        // 处理可能的HTML不完整问题
        tempDiv.innerHTML = html.includes('<html') ? html : `<html><head></head><body>${html}</body></html>`;
        
        const styleTags = tempDiv.querySelectorAll('style');
        let allCss = '';
        
        styleTags.forEach(tag => {
          allCss += tag.innerHTML + '\n\n';
          tag.remove();
        });
        
        const linkTags = tempDiv.querySelectorAll('link[rel="stylesheet"]');
        linkTags.forEach(tag => {
          allCss += `/* 外部CSS: ${tag.href} */\n`;
          tag.remove();
        });
        
        if (allCss.trim()) {
          const newStyleTag = document.createElement('style');
          newStyleTag.innerHTML = allCss.trim();
          
          let head = tempDiv.querySelector('head');
          if (!head) {
            head = document.createElement('head');
            const htmlTag = tempDiv.querySelector('html') || tempDiv;
            htmlTag.insertBefore(head, htmlTag.firstChild);
          }
          head.appendChild(newStyleTag);
        }
        
        return tempDiv.innerHTML;
      }
      
      // 整合JavaScript代码的函数
      function consolidateJS(html) {
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = html.includes('<html') ? html : `<html><head></head><body>${html}</body></html>`;
        
        const scriptTags = tempDiv.querySelectorAll('script');
        let allJs = '';
        
        scriptTags.forEach(tag => {
          if (tag.src) {
            allJs += `/* 外部脚本: ${tag.src} */\n\n`;
          } else {
            allJs += tag.innerHTML + '\n\n';
          }
          tag.remove();
        });
        
        if (allJs.trim()) {
          const newScriptTag = document.createElement('script');
          newScriptTag.innerHTML = allJs.trim();
          
          let body = tempDiv.querySelector('body');
          if (!body) {
            body = document.createElement('body');
            const htmlTag = tempDiv.querySelector('html') || tempDiv;
            htmlTag.appendChild(body);
          }
          body.appendChild(newScriptTag);
        }
        
        return tempDiv.innerHTML;
      }
      
      // 预览功能
      function showPreview() {
        const htmlContent = codeEditor.value.trim();
        
        if (!htmlContent) {
          showNotification('编辑器内容为空，无法预览', 'warning');
          return;
        }
        
        previewModal.classList.remove('hidden');
        previewLoading.classList.remove('hidden');
        previewError.classList.add('hidden');
        document.body.style.overflow = 'hidden';
        
        const previewHtml = `
          <!DOCTYPE html>
          <html lang="zh-CN">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>预览 - ${originalFileName}</title>
            <base target="_blank">
          </head>
          <body>
            ${htmlContent}
          </body>
          </html>
        `;
        
        try {
          if (previewTimeout) clearTimeout(previewTimeout);
          
          const blob = new Blob([previewHtml], { type: 'text/html; charset=utf-8' });
          const previewUrl = URL.createObjectURL(blob);
          
          previewIframe.onload = function() {
            previewTimeout = setTimeout(() => {
              previewLoading.classList.add('hidden');
            }, 500);
          };
          
          previewIframe.onerror = function() {
            clearTimeout(previewTimeout);
            previewLoading.classList.add('hidden');
            previewError.classList.remove('hidden');
            console.error('预览加载失败');
          };
          
          previewIframe.src = previewUrl;
          
          setTimeout(() => {
            URL.revokeObjectURL(previewUrl);
          }, 1000);
          
        } catch (error) {
          clearTimeout(previewTimeout);
          previewLoading.classList.add('hidden');
          previewError.classList.remove('hidden');
          console.error('预览生成失败:', error);
        }
      }
      
      previewBtn.addEventListener('click', showPreview);
      previewToolBtn.addEventListener('click', showPreview);
      
      closePreview.addEventListener('click', function() {
        previewModal.classList.add('hidden');
        document.body.style.overflow = '';
        previewIframe.src = 'about:blank';
        if (previewTimeout) clearTimeout(previewTimeout);
      });
      
      previewModal.addEventListener('click', function(e) {
        if (e.target === previewModal) {
          closePreview.click();
        }
      });
      
      refreshPreview.addEventListener('click', function() {
        showPreview();
      });
      
      retryPreview.addEventListener('click', function() {
        showPreview();
      });
      
      // 全屏预览
      fullscreenPreview.addEventListener('click', function() {
        const previewContainer = previewIframe.parentElement;
        
        if (!document.fullscreenElement) {
          if (previewContainer.requestFullscreen) {
            previewContainer.requestFullscreen();
          } else if (previewContainer.webkitRequestFullscreen) {
            previewContainer.webkitRequestFullscreen();
          } else if (previewContainer.msRequestFullscreen) {
            previewContainer.msRequestFullscreen();
          }
          fullscreenPreview.innerHTML = '<i class="fa fa-compress text-gray-700"></i>';
          fullscreenPreview.title = '退出全屏';
        } else {
          if (document.exitFullscreen) {
            document.exitFullscreen();
          } else if (document.webkitExitFullscreen) {
            document.webkitExitFullscreen();
          } else if (document.msExitFullscreen) {
            document.msExitFullscreen();
          }
          fullscreenPreview.innerHTML = '<i class="fa fa-expand text-gray-700"></i>';
          fullscreenPreview.title = '全屏预览';
        }
      });
      
      // 监听全屏状态变化
      document.addEventListener('fullscreenchange', updateFullscreenButton);
      document.addEventListener('webkitfullscreenchange', updateFullscreenButton);
      document.addEventListener('msfullscreenchange', updateFullscreenButton);
      
      function updateFullscreenButton() {
        if (document.fullscreenElement) {
          fullscreenPreview.innerHTML = '<i class="fa fa-compress text-gray-700"></i>';
          fullscreenPreview.title = '退出全屏';
        } else {
          fullscreenPreview.innerHTML = '<i class="fa fa-expand text-gray-700"></i>';
          fullscreenPreview.title = '全屏预览';
        }
      }
      
      // 初始化
      initHiddenElements();
      updateLineNumbers();
      
      // 监听窗口滚动，改变导航栏样式
      window.addEventListener('scroll', function() {
        const header = document.querySelector('header');
        if (window.scrollY > 10) {
          header.classList.add('py-2');
          header.classList.remove('py-3');
        } else {
          header.classList.add('py-3');
          header.classList.remove('py-2');
        }
      });
      
      // 检查运行环境
      if (window.location.protocol === 'file:') {
        setTimeout(() => {
          showNotification('当前为本地文件模式，部分功能可能受限，建议使用HTTP服务器环境', 'warning');
        }, 2000);
      }
    });
  </script>
</body>
</html>
